# About

`offlineimap_configuration_generator` is barely a program, but it does manage to convert a YAML document into a configuration format that [`offlineimap`](http://offlineimap.org) will accept.

It takes the name of your YAML file as its sole input, and it sends `offlineimap` configuration to stdout.

The purpose was to help me write the necessary configuration to migrate an organization's IMAP email, without losing my mind.

The documentation for this script took longer to write than the script itself, so if it doesn't do what you want, I won't be surprised.

## License

This project uses the same license as `offlineimap`, [GPL 2+](https://raw.githubusercontent.com/OfflineIMAP/offlineimap/master/COPYING).

## Installation

This script, somewhere, and PyYAML installed. Having access to a working copy of `offlineimap` will enable greater usement of its functionalities.

## Usage

Something like this, perhaps, using `--dry-run` to make sure all of the values are accepted.

This script has actually only been tested to synchronize IMAP mailboxes. `offlineimap` has a ton of features, almost 100% of which I have not ever used. However you can use this program to insert any keys into your configuration so it might work.

./offlineimap_configuration_generator example-input.yml > example-output.cfg

offlineimap -c example-output.cfg -u ttyui --dry-run

## Input Format

See the included `example-input.yml`.

A YAML document with the following keys at the top level: `general`, `defaults`, `accounts`, `allowed_address_domains`.

### Key translation

Keys and values in the YAML document are written into the output configuration without change. However, a few keys have aliases when they are used within the  `accounts` (or supplied in `defaults`):

- `username` becomes `remoteuser` in the output
- `host` becomes `remotehost`
- `post` becomes `remoteport`
- `password` becomes `remotepass`

### `allowed_address_domains`

An optional key of dubious utility, which specifies a whitelist of allowed mail domains. The purpose is to prevent typographical errors from ruining a run. 

If this key is present, it is assumed that user names will be fully specified by domain (e.g., `joe@example.com`, not just `joe`). Before generating the configuration the program will make sure that all user names are in the appropriate whitelist. Two keys are recognized within this block, `from` and `to`. Each must contain a list of accepted domains.

E.g., if we have `from: [example.com]` then the program will halt on input which contains a user's source account `joe@exampel.com`.

### `general`

Every key and value pair in this YAML block will be written into the `offlineimap` configuration `[general]` block, such that

`somekey: some value` becomes `somekey = some value` (no key translation is performed here)

### `accounts`

This block contains a list of dictionary blocks, where each dictionary has the required keys `from` and `to`. An `offlineimap` Account block is generated for each pair of `from` and `to` blocks, where the `from` and `to` blocks are used to generate `offlineimap` Repository blocks. Keys and values are written from the YAML configuration into the `offlineimap` configuration such that:

 `somekey: some value` becomes `somekey = some value`
 
Except where `somekey` is one of the translated keys (see Key translation above).

### `defaults`

Consisting of three keys, `all`, `from` and `to`, this blocks are merged into account `from` and `to` blocks when the output is generated. This allows you to supply, for instance, a `type`, `host` or `cert_fingerprint` for every account (or just the 'from' or 'to' side of every account) blocks, without repetition.

## Output format

The `[general]` block is placed at the top. Account names are generated by mangling the 'from.username' key in each `account` object. Repository names are generated by further mangling the account names. No effort is made to ensure that account or repository names are any more unique than your usernames.
